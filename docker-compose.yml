services:
  pocketbase:
    build:
      context: .
      args:
        PB_VERSION: ${PB_VERSION:-0.22.14}
        PB_ARCH: ${PB_ARCH:-linux_amd64}
        # Frontend build-time envs (used by Vite build in Dockerfile)
        VITE_POCKETDB_URL: ${VITE_POCKETDB_URL:-http://clean-quest-pocketbase:8090}
        VITE_BASE: ${VITE_BASE:-/}
        SKIP_TESTS: ${SKIP_TESTS:-true}
    image: clean-quest-pocketbase:latest
    user: "${UID:-1000}:${GID:-1000}"
    ports:
      - "8090:8090"
    volumes:
      - ./pb_data:/pb/pb_data
      - ./pb_migrations:/pb/pb_migrations:ro
    networks: [clean-quest]

  web-dev:
    profiles: ["dev"]
    image: node:20-alpine
    working_dir: /app
    command: sh -c "npm install --no-audit --no-fund && npm run dev -- --host 0.0.0.0 --port 5173"
    ports:
      - "5173:5173"
    environment:
      PB_INTERNAL_URL: http://pocketbase:8090
    volumes:
      - .:/app
    user: "${UID:-1000}:${GID:-1000}"
    depends_on:
      - pocketbase
    networks: [clean-quest]

networks:
  clean-quest:
    name: clean-quest-net